---
import MaskedSignature from "@/assets/maskedSignature.svg";
---

<section
  id="hero"
  class="relative min-h-dvh bg-gradient-to-b from-black to-midnight flex items-center justify-center sticky top-0 relative"
>
  <canvas
    id="hero-canvas"
    class="absolute w-full h-full aspect-video opacity-50 after:bg-radial after:from-midnight after:to-transparent"
  ></canvas>
  <div
    id="hero-content"
    class="flex flex-col justify-center items-center px-6 text-center w-full max-w-5xl"
  >
    <div class="mb-12 lg:mb-16" id="title-container">
      <h1
        class="text-6xl sm:text-8xl lg:text-9xl xl:text-[12rem] font-black text-smoke leading-none tracking-tighter mb-4 hero-glow hero-text"
        id="main-title"
      >
        AKUMU
      </h1>
      <h2
        class="text-4xl sm:text-6xl lg:text-7xl xl:text-8xl font-extralight text-smoke/90 leading-none tracking-widest hero-text"
        id="sub-title"
      >
        GALLERY
      </h2>
    </div>

    <div class="max-w-2xl mb-16" id="subtitle-container">
      <p
        class="text-lg sm:text-xl lg:text-2xl text-smoke/80 font-light leading-relaxed drop-shadow hero-text"
        id="description"
      >
        Where nightmares become art, and darkness finds its beauty
      </p>
    </div>

    <div class="flex items-center gap-6 mb-16" id="signature-container">
      <MaskedSignature
        class="w-48 lg:w-64 h-auto text-smoke/80"
        id="signature"
      />
    </div>
  </div>
  <div class="absolute bottom-8 w-full" id="scroll-indicator">
    <div
      class="flex flex-col min-h-20 gap-2 items-center text-smoke/60 mx-auto"
    >
      <span id="scroll-text" class="text-sm animate-pulse"
        >SCROLL TO EXPLORE</span
      >
      <div
        id="scroll-line"
        class="w-px h-12 bg-gradient-to-b from-smoke/60 to-transparent animate-down"
      >
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const signature = ["#sig-path1", "#sig-path2", "#sig-path3", "#sig-path4"];
  const canvas = document.getElementById("hero-canvas") as HTMLCanvasElement;
  const ctx = canvas?.getContext("2d");

  canvas.width = 640;
  canvas.height = 360;

  window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    renderFrame();
  });

  const video = { frame: 1 };
  const totalFrames = 60;
  const frames: HTMLImageElement[] = [];

  const timeline = gsap.timeline();
  const fadeOut = {
    scrollTrigger: {
      start: "middle",
      scrub: true,
      markers: true,
    },
    filter: "blur(10px)",
    autoAlpha: 0,
    scale: 2,
    duration: 1,
  };

  const renderFrame = () => {
    if (ctx && frames[video.frame]) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(frames[video.frame], 0, 0);
    }
  };

  const loadImages = async () => {
    const imagePromises = [];

    for (let i = 1; i <= totalFrames; i++) {
      const promise = new Promise<HTMLImageElement>((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = `/frames/unscreen-${i.toString().padStart(3, "0")}.png`;
      });
      imagePromises.push(promise);
    }

    try {
      const loadedImages = await Promise.all(imagePromises);
      frames.push(...loadedImages);
      console.log("All images loaded:", frames.length);
      renderFrame(); // Now render after images are loaded
    } catch (error) {
      console.error("Error loading images:", error);
    }
  };

  loadImages();

  signature.forEach((p) => {
    const path = document.querySelector(p) as SVGPathElement;
    if (path && path.getTotalLength) {
      const length = path.getTotalLength();
      path.style.strokeDasharray = length.toString();
      path.style.strokeDashoffset = length.toString();
    }
  });

  timeline
    .from("#main-title", {
      scale: 1.1,
      ease: "power2.out",
      autoAlpha: 0,
      duration: 2,
      filter: "blur(10px)",
    })
    .from(
      "#sub-title",
      {
        scale: 1.1,
        ease: "power2.out",
        autoAlpha: 0,
        duration: 2,
        filter: "blur(10px)",
      },
      "-=2"
    )
    .from(
      "#description",
      {
        ease: "power2.out",
        autoAlpha: 0,
        duration: 2,
        filter: "blur(10px)",
      },
      "-=2"
    )
    .to(
      "#sig-path1",
      {
        strokeDashoffset: 0,
        duration: 1,
        ease: "power2.out",
      },
      "-=1"
    )
    .to(
      "#sig-path2",
      { strokeDashoffset: 0, duration: 1, ease: "power1.inOut" },
      "-=0.3"
    )
    .to(
      "#sig-path3",
      { strokeDashoffset: 0, duration: 0.5, ease: "power2.inOut" },
      "-=0.2"
    )
    .to(
      "#sig-path4",
      { strokeDashoffset: 0, duration: 0.3, ease: "power1.out" },
      "-=0.1"
    )
    .from(
      "#scroll-line",
      {
        height: 0,
        duration: 1,
        ease: "power2.out",
        transformOrigin: "top",
      },
      "-=0.1"
    )
    .from(
      "#scroll-text",
      {
        y: -10,
        autoAlpha: 0,
        duration: 1,
        ease: "power2.out",
      },
      "-=0.75"
    );

  gsap.to("#hero-content", fadeOut);
  gsap.to("#scroll-indicator", fadeOut);

  gsap.from("#hero-canvas", {
    scrollTrigger: {
      trigger: "#hero",
      start: "top top",
      end: "bottom center",
      scrub: true,
      markers: true,
    },
    autoAlpha: 0,
  });

  gsap.to(video, {
    scrollTrigger: {
      trigger: "#hero",
      start: "top top",
      end: "bottom center",
      scrub: 0.5,
      markers: true,
    },
    ease: "none",
    snap: "frame",
    frame: totalFrames - 1,
    onUpdate: renderFrame,
  });

  renderFrame();
</script>
